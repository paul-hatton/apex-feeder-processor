<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Band/Orchestra Student Finder</title>
  <!-- PDF.js library for reading PDF text -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
  <!-- pdf-lib library for creating the new PDF -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .version {
      text-align: center;
      margin-bottom: 20px;
      color: #7f8c8d;
      font-size: 14px;
    }
    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      color: #7f8c8d;
      font-size: 16px;
    }
    .instruction-box {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-left: 4px solid #4285f4;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 25px;
    }
    .instruction-box h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    .instruction-box ol {
      margin-bottom: 0;
      padding-left: 20px;
    }
    .instruction-box p {
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    select, input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      background-color: white;
    }
    .file-info {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2b68c7;
    }
    button:disabled {
      background-color: #a5a5a5;
      cursor: not-allowed;
    }
    .progress-container {
      margin-top: 20px;
    }
    .progress-text {
      margin-bottom: 8px;
      font-size: 14px;
    }
    .progress-bar {
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #4285f4;
      width: 0%;
      transition: width 0.3s;
    }
    .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info-message {
      background-color: #e2f3fd;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .hidden {
      display: none;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .button-group button, .button-group a {
      flex: 1;
    }
    .download-link {
      display: block;
      text-align: center;
      padding: 12px;
      background-color: #4caf50;
      color: white;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      text-decoration: none;
      transition: background-color 0.3s;
    }
    .download-link:hover {
      background-color: #388e3c;
    }
    .pdf-preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      height: 500px;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .secondary-button {
      background-color: white;
      color: #4285f4;
      border: 1px solid #4285f4;
    }
    .secondary-button:hover {
      background-color: #f5f5f5;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 14px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Band/Orchestra Student Finder</h1>
  <p class="version">Version 4.1</p>
  <p class="subtitle">Find and contact potential band/orchestra students in your feeder form reports</p>

  <div class="instruction-box">
    <h3>How to Get Your Student Feeder Report</h3>
    <p>Dear Teachers - Want to know all the kids coming to your school next year that are already in band or orchestra? Follow these steps:</p>
    <ol>
      <li>Go to <strong>sis.pgcps.org</strong> and click <strong>Apex Reports</strong> at the bottom <em>(only accessible at school or through the VPN)</em></li>
      <li>Top Menu: <strong>School â†’ Enrollment</strong></li>
      <li>Click <strong>"Feeder Forms"</strong></li>
      <li>Set <strong>"Receiving School"</strong> to your school (if shown)</li>
      <li>Set <strong>"Current Grade Level"</strong> to <strong>"-- ALL --"</strong></li>
      <li>Click <strong>"Generate Feeder Forms"</strong></li>
    </ol>
    <p>Once the PDF downloads, upload it here to automatically find all students currently in band or orchestra. The filtered PDF will include their parent contact information so you can reach out now!</p>
  </div>

  <div id="upload-form">
    <div class="form-group">
      <label for="file-upload">Upload Your Feeder Form PDF</label>
      <input type="file" id="file-upload" accept=".pdf">
      <div id="file-info" class="file-info"></div>
    </div>

    <div class="form-group">
      <label for="filter-type">Find Students In:</label>
      <select id="filter-type">
        <option value="both">Both Band and Orchestra</option>
        <option value="band">Only Band</option>
        <option value="orchestra">Only Orchestra</option>
      </select>
    </div>

    <button id="process-button" disabled>Find Students</button>

    <div id="progress-container" class="progress-container hidden">
      <p id="progress-text" class="progress-text">Processing PDF...</p>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
    </div>

    <div id="status-message" class="status-message hidden"></div>
  </div>

  <div id="result-container" class="hidden">
    <div class="status-message success-message" id="summary-message"></div>
    <div class="button-group">
      <a id="download-report" class="download-link" download="band_orchestra_students.pdf">Download Student List</a>
      <button id="reset-button" class="secondary-button">Process Another Report</button>
    </div>
    <div class="pdf-preview">
      <iframe id="pdf-preview" title="PDF Report Preview"></iframe>
    </div>
  </div>

  <footer>
    <p>All processing happens in your browser. No files are uploaded to a server.</p>
  </footer>
</div>

<script>
  // Set up PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

  // DOM elements
  const fileUpload        = document.getElementById('file-upload');
  const fileInfo          = document.getElementById('file-info');
  const filterType        = document.getElementById('filter-type');
  const processButton     = document.getElementById('process-button');
  const progressContainer = document.getElementById('progress-container');
  const progressText      = document.getElementById('progress-text');
  const progressFill      = document.getElementById('progress-fill');
  const statusMessage     = document.getElementById('status-message');
  const resultContainer   = document.getElementById('result-container');
  const summaryMessage    = document.getElementById('summary-message');
  const downloadReport    = document.getElementById('download-report');
  const pdfPreview        = document.getElementById('pdf-preview');
  const resetButton       = document.getElementById('reset-button');
  const uploadForm        = document.getElementById('upload-form');

  let selectedFile = null;
  let filteredPdfUrl = null;

  // Event listeners
  fileUpload.addEventListener('change', handleFileSelection);
  processButton.addEventListener('click', processPDF);
  resetButton.addEventListener('click', resetForm);

  function handleFileSelection(e) {
    const file = e.target.files[0];
    if (file && file.type === 'application/pdf') {
      selectedFile = file;
      fileInfo.textContent = `Selected file: ${file.name}`;
      processButton.disabled = false;
      hideStatusMessage();
    } else {
      showStatusMessage('Please select a valid PDF file.', 'error');
      resetFileInput();
    }
  }

  function resetFileInput() {
    fileUpload.value = '';
    fileInfo.textContent = '';
    selectedFile = null;
    processButton.disabled = true;
  }

  function showStatusMessage(message, type = 'info') {
    statusMessage.textContent = message;
    statusMessage.className = `status-message ${type}-message`;
    statusMessage.classList.remove('hidden');
  }

  function hideStatusMessage() {
    statusMessage.classList.add('hidden');
  }

  function setProgress(value) {
    progressFill.style.width = value + '%';
  }

  function updateProgressText(text) {
    progressText.textContent = text;
  }

  async function processPDF() {
    if (!selectedFile) return;

    // Prepare UI
    processButton.disabled = true;
    progressContainer.classList.remove('hidden');
    hideStatusMessage();
    setProgress(0);
    updateProgressText('Reading file...');

    try {
      const filterOption = filterType.value; // "both", "band", "orchestra"
      const fileData     = await readFileAsUint8Array(selectedFile);

      // Load with PDF.js to extract text
      const pdfJsDoc  = await pdfjsLib.getDocument(fileData).promise;
      const totalPages = pdfJsDoc.numPages;

      // Also load with pdf-lib to copy pages
      const originalPdfLibDoc = await PDFLib.PDFDocument.load(fileData);
      const newPdfDoc         = await PDFLib.PDFDocument.create();

      // Keep track of how many pages matched each term
      let bandCount = 0;
      let orchestraCount = 0;

      for (let i = 1; i <= totalPages; i++) {
        setProgress(Math.floor((i / totalPages) * 100));
        updateProgressText(`Scanning page ${i} of ${totalPages}...`);

        const page     = await pdfJsDoc.getPage(i);
        const textCont = await page.getTextContent();
        const pageText = textCont.items.map(item => item.str.toUpperCase()).join(' ');

        const hasBand       = pageText.includes('BAND');
        const hasOrchestra  = pageText.includes('ORCHESTRA');

        // Decide if we keep this page based on filter
        let keepPage = false;
        if (filterOption === 'both') {
          keepPage = hasBand || hasOrchestra;
        } else if (filterOption === 'band') {
          keepPage = hasBand;
        } else if (filterOption === 'orchestra') {
          keepPage = hasOrchestra;
        }

        if (keepPage) {
          const [copiedPage] = await newPdfDoc.copyPages(originalPdfLibDoc, [i - 1]);
          newPdfDoc.addPage(copiedPage);

          if (hasBand) bandCount++;
          if (hasOrchestra) orchestraCount++;
        }
      }

      // If no pages matched, show message
      if (newPdfDoc.getPageCount() === 0) {
        progressContainer.classList.add('hidden');
        showStatusMessage('No students found with band or orchestra in their schedule.', 'error');
        processButton.disabled = false;
        return;
      }

      updateProgressText('Creating student list...');
      const newPdfBytes = await newPdfDoc.save();
      const newPdfBlob  = new Blob([newPdfBytes], { type: 'application/pdf' });
      const newPdfUrl   = URL.createObjectURL(newPdfBlob);

      // Show a brief summary with student count estimate
      let summary = '';
      let studentEstimate = Math.max(bandCount, orchestraCount);
      
      if (filterOption === 'both') {
        summary = `Found approximately ${studentEstimate} students currently in band or orchestra.
          - ${bandCount} student page(s) with "BAND" in their schedule
          - ${orchestraCount} student page(s) with "ORCHESTRA" in their schedule`;
      } else if (filterOption === 'band') {
        summary = `Found approximately ${bandCount} students currently in band.`;
      } else {
        summary = `Found approximately ${orchestraCount} students currently in orchestra.`;
      }

      summaryMessage.textContent = summary;

      // Initiate automatic download
      downloadReport.href = newPdfUrl;
      downloadReport.download = 'band_orchestra_students.pdf';
      downloadReport.click(); // auto-download

      // Show final UI
      progressContainer.classList.add('hidden');
      uploadForm.classList.add('hidden');
      resultContainer.classList.remove('hidden');
      pdfPreview.src = newPdfUrl;
      filteredPdfUrl = newPdfUrl;

    } catch (err) {
      console.error(err);
      showStatusMessage('Error processing PDF: ' + err.message, 'error');
      processButton.disabled = false;
      progressContainer.classList.add('hidden');
    }
  }

  function resetForm() {
    fileUpload.value = '';
    fileInfo.textContent = '';
    processButton.disabled = true;
    progressContainer.classList.add('hidden');
    resultContainer.classList.add('hidden');
    uploadForm.classList.remove('hidden');
    hideStatusMessage();
    selectedFile = null;
    setProgress(0);
    updateProgressText('Processing PDF...');
    pdfPreview.src = '';

    if (filteredPdfUrl) {
      URL.revokeObjectURL(filteredPdfUrl);
      filteredPdfUrl = null;
    }
  }

  function readFileAsUint8Array(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(new Uint8Array(e.target.result));
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }
</script>
</body>
</html>
