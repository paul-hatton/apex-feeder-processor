<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Processor for Band/Orchestra</title>
  <!-- PDF.js library for reading PDF text -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
  <!-- pdf-lib library for building PDF -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .version {
      text-align: center;
      margin-bottom: 20px;
      color: #7f8c8d;
      font-size: 14px;
    }
    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      color: #7f8c8d;
      font-size: 16px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    select, input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      background-color: white;
    }
    .file-info {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2b68c7;
    }
    button:disabled {
      background-color: #a5a5a5;
      cursor: not-allowed;
    }
    .progress-container {
      margin-top: 20px;
    }
    .progress-text {
      margin-bottom: 8px;
      font-size: 14px;
    }
    .progress-bar {
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #4285f4;
      width: 0%;
      transition: width 0.3s;
    }
    .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info-message {
      background-color: #e2f3fd;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .results-summary {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 16px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .button-group button {
      flex: 1;
    }
    .pdf-preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      height: 500px;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .secondary-button {
      background-color: white;
      color: #4285f4;
      border: 1px solid #4285f4;
    }
    .secondary-button:hover {
      background-color: #f5f5f5;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 14px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>PDF Processor for Band/Orchestra</h1>
  <p class="version">Version 4.0 - Simplified</p>
  <p class="subtitle">Find pages containing "BAND" and/or "ORCHESTRA" and remove other pages.</p>

  <div id="upload-form">
    <div class="form-group">
      <label for="file-upload">Upload PDF File</label>
      <input type="file" id="file-upload" accept=".pdf">
      <div id="file-info" class="file-info"></div>
    </div>

    <div class="form-group">
      <label for="filter-type">Filter Type</label>
      <select id="filter-type">
        <option value="both">Both Band and Orchestra</option>
        <option value="band">Only Band</option>
        <option value="orchestra">Only Orchestra</option>
      </select>
    </div>

    <button id="process-button" disabled>Process PDF</button>

    <div id="progress-container" class="progress-container hidden">
      <p id="progress-text" class="progress-text">Processing PDF...</p>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
    </div>

    <div id="status-message" class="status-message hidden"></div>
  </div>

  <div id="result-container" class="hidden">
    <div class="status-message success-message">PDF processed successfully!</div>
    <div id="results-summary" class="results-summary">
      <!-- Summary will be displayed here -->
    </div>
    <div class="button-group">
      <button id="reset-button" class="secondary-button">Process Another PDF</button>
    </div>
    <div class="pdf-preview">
      <iframe id="pdf-preview" title="PDF Report Preview"></iframe>
    </div>
  </div>

  <footer>
    <p>PDF processing is done entirely in your browser. No files are uploaded to any server.</p>
  </footer>
</div>

<script>
  // PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

  // DOM elements
  const fileUpload        = document.getElementById('file-upload');
  const fileInfo          = document.getElementById('file-info');
  const filterType        = document.getElementById('filter-type');
  const processButton     = document.getElementById('process-button');
  const progressContainer = document.getElementById('progress-container');
  const progressText      = document.getElementById('progress-text');
  const progressFill      = document.getElementById('progress-fill');
  const statusMessage     = document.getElementById('status-message');
  const resultContainer   = document.getElementById('result-container');
  const resultsSummary    = document.getElementById('results-summary');
  const pdfPreview        = document.getElementById('pdf-preview');
  const resetButton       = document.getElementById('reset-button');
  const uploadForm        = document.getElementById('upload-form');

  let selectedFile = null;
  let reportPdfUrl = null;

  fileUpload.addEventListener('change', handleFileSelection);
  processButton.addEventListener('click', processPDF);
  resetButton.addEventListener('click', resetForm);

  function handleFileSelection(e) {
    const file = e.target.files[0];
    if (file && file.type === 'application/pdf') {
      selectedFile = file;
      fileInfo.textContent = `Selected file: ${file.name}`;
      processButton.disabled = false;
      hideStatusMessage();
    } else {
      showStatusMessage('Please select a valid PDF file.', 'error');
      resetFileInput();
    }
  }

  function resetFileInput() {
    fileUpload.value = '';
    fileInfo.textContent = '';
    selectedFile = null;
    processButton.disabled = true;
  }

  function showStatusMessage(message, type = 'info') {
    statusMessage.textContent = message;
    statusMessage.className = `status-message ${type}-message`;
    statusMessage.classList.remove('hidden');
  }

  function hideStatusMessage() {
    statusMessage.classList.add('hidden');
  }

  function setProgress(value) {
    progressFill.style.width = `${value}%`;
  }

  function updateProgressText(text) {
    progressText.textContent = text;
  }

  async function processPDF() {
    if (!selectedFile) return;

    try {
      processButton.disabled = true;
      progressContainer.classList.remove('hidden');
      hideStatusMessage();
      setProgress(0);

      const filterOption = filterType.value; // "both", "band", or "orchestra"
      const searchTerms = [];
      if (filterOption === 'both' || filterOption === 'band') {
        searchTerms.push('BAND');
      }
      if (filterOption === 'both' || filterOption === 'orchestra') {
        searchTerms.push('ORCHESTRA');
      }

      updateProgressText('Reading PDF file...');
      const fileData = await readFileAsUint8Array(selectedFile);

      updateProgressText('Loading PDF for analysis...');
      const pdfDocument = await pdfjsLib.getDocument(fileData).promise;
      const totalPages  = pdfDocument.numPages;

      updateProgressText(`PDF loaded. Total pages: ${totalPages}`);
      const matchingPagesByTerm = {
        'BAND': [],
        'ORCHESTRA': []
      };

      // We'll also load the PDF with pdf-lib so we can copy pages
      const originalPdfLibDoc = await PDFLib.PDFDocument.load(fileData);
      // New PDF to store the filtered pages
      const newPdfDoc = await PDFLib.PDFDocument.create();

      // Track which pages to include in the final PDF (no duplicates)
      const pagesToInclude = new Set();

      for (let i = 1; i <= totalPages; i++) {
        setProgress(Math.floor((i / totalPages) * 100));
        updateProgressText(`Analyzing page ${i} of ${totalPages}...`);

        const page = await pdfDocument.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(it => it.str.toUpperCase()).join(' ');

        // Check if page matches any search terms
        let matchedTerm = false;
        for (const term of searchTerms) {
          if (pageText.includes(term)) {
            matchingPagesByTerm[term].push(i);
            matchedTerm = true;
            pagesToInclude.add(i - 1); // Zero-indexed for pdf-lib
          }
        }
      }

      // Check if we found any matching pages
      const totalMatches = pagesToInclude.size;
      if (totalMatches === 0) {
        progressContainer.classList.add('hidden');
        showStatusMessage('No pages found containing the selected terms.', 'error');
        processButton.disabled = false;
        return;
      }

      // Copy matched pages from original PDF into new PDF
      updateProgressText('Creating new PDF with matched pages...');
      const pagesToIncludeArray = Array.from(pagesToInclude);
      const copiedPages = await newPdfDoc.copyPages(originalPdfLibDoc, pagesToIncludeArray);
      copiedPages.forEach(page => newPdfDoc.addPage(page));

      // Generate summary text
      let summaryText = '';
      if (filterOption === 'both') {
        const bandPages = matchingPagesByTerm['BAND'].length;
        const orchestraPages = matchingPagesByTerm['ORCHESTRA'].length;
        summaryText = `Found ${totalMatches} total pages: ${bandPages} with "BAND" and ${orchestraPages} with "ORCHESTRA".`;
      } else if (filterOption === 'band') {
        summaryText = `Found ${totalMatches} pages containing "BAND".`;
      } else {
        summaryText = `Found ${totalMatches} pages containing "ORCHESTRA".`;
      }
      
      // Update the results summary
      resultsSummary.textContent = summaryText;

      // Save new PDF
      updateProgressText('Generating new PDF...');
      const newPdfBytes = await newPdfDoc.save();
      const newPdfBlob  = new Blob([newPdfBytes], { type: 'application/pdf' });
      const newPdfUrl   = URL.createObjectURL(newPdfBlob);

      // Set preview and initiate download
      pdfPreview.src = newPdfUrl;
      reportPdfUrl = newPdfUrl;  // keep track to revoke if reset

      // Auto-download the PDF
      const downloadLink = document.createElement('a');
      downloadLink.href = newPdfUrl;
      downloadLink.download = 'filtered-' + selectedFile.name;
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);

      // Show final results
      progressContainer.classList.add('hidden');
      uploadForm.classList.add('hidden');
      resultContainer.classList.remove('hidden');

    } catch (err) {
      console.error('Error processing PDF:', err);
      showStatusMessage(`Error processing PDF: ${err.message}`, 'error');
      processButton.disabled = false;
      progressContainer.classList.add('hidden');
    }
  }

  function readFileAsUint8Array(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(new Uint8Array(e.target.result));
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }

  function resetForm() {
    fileUpload.value = '';
    fileInfo.textContent = '';
    processButton.disabled = true;
    progressContainer.classList.add('hidden');
    resultContainer.classList.add('hidden');
    uploadForm.classList.remove('hidden');
    hideStatusMessage();
    selectedFile = null;
    setProgress(0);
    updateProgressText('Processing PDF...');
    pdfPreview.src = '';

    if (reportPdfUrl) {
      URL.revokeObjectURL(reportPdfUrl);
      reportPdfUrl = null;
    }
  }
</script>
</body>
</html>
